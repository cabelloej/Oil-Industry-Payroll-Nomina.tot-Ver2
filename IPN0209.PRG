*********************************************************************************
*                  PROGRAMA PARA CERRAR NOMINA Y CREAR HISTORICO               *
********************************************************************************
store "INSTALACION NO AUTORIZADA" to warning
STORE "CIERRE DE NOMINAS" TO T2
SELECT 1 
USE IPNOMINA INDEX IPNOMINA ALIAS NOMINA
SELECT 2
USE IPNPROCO INDEX IPNPROCO ALIAS PROCESO
SELECT 4
USE IPNPERSO  ALIAS PERSONAL
SELECT 6
USE IPNHISTO INDEX IPNHISTO, IPNHIST2 ALIAS HISTORIA
STORE .T. TO REPORTA
DO WHILE REPORTA
   STORE .T. TO ZNOMINA
   DO WHILE ZNOMINA
      STORE 0 TO WWTOTA
      STORE 0 TO WWTOTB
      STORE 0 TO WWTOTC
      STORE 0 TO WWTOTD
      SELECT 1
      STORE SPACE(5) TO WCODNOM
      SET COLOR TO W+/B
      @ 5,1 CLEAR TO 12,50
      @ 5,1 TO 12,50 DOUBLE
      @ 5,25-(LEN(T2)/2) SAY T2
      STORE "CODIGO DE NOMINA" to mess
      do mensaje with mess
      @ 7,3 say "NOMINA    : " GET WCODNOM
      @ 9,3 SAY "DECRIPCION: "
      READ
      STORE UPPER(WCODNOM) TO WCODNOM
      IF WCODNOM=SPACE(5)
         CLOSE DATA
         CLOSE INDEX
         RETURN
      ENDIF
      FIND &WCODNOM

      IF EOF()
         STORE "NOMINA NO REGISTRADA" to mes
         do aviso with mes
         loop
      endif
      @ 9,15 SAY DESNOM
      STORE "OPCIONES: (C)ONTINUAR, (R)ECHAZAR" to mes
      store "C" to p1
      store "R" to p2
      STORE " " TO RESP
      DO PIDE2 WITH P1,P2,MES,RESP
      IF RESP = "R"
         LOOP
      ENDIF
      IF ESTADO = 0
         STORE "ERROR, esta nomina ya esta cerrada " to mes
         do aviso with mes
         loop
      endif
      IF ESTADO < 4
         STORE "ERROR, usted debe imprimir el resumen conceptual antes de esta operacion " to mes
         do aviso with mes
         loop
      else
         store .f. to Znomina
         loop
      endif
   ENDDO
   STORE SPACE(35) TO QQWW
   DO INFORMA WITH QQWW
   IF QQWW <> t3
      STORE 1 TO POSI
      else
      STORE 0 TO POSI
   ENDIF
   STORE FACTCOD TO WFACTOR
   SELECT 3
   USE IPNFACTOR INDEX IPNFACTOR ALIAS TABLA
   FIND &WFACTOR
   IF EOF()
      STORE "ERROR, TABLA DE FACTORES DE ESTA NOMINA NO ESTA REGISTRADA" TO MES
      DO AVISO WITH MESS
      LOOP
   ENDIF

   STORE "CERRANDO NOMINA, FAVOR ESPERAR ..." to mes
   do mensaje with mes
   STORE 0 TO GENTE
   STORE 0 TO VEZ
   SELECT 4
   LOCATE FOR NOMINA = WCODNOM
   DO WHILE .NOT. EOF()
      STORE MP TO WMP
      STORE CP TO WCP
      STORE CEDULA TO WCEDULA
      SELECT 2
      FIND &WCEDULA
      IF EOF()
         STORE "ADVERTENCIA:"+RTRIM(personal->nombre)+" "+RTRIM(personal->apellido)+" sin reg. de corte." to mes
         SET DEVI TO SCREE
         @ 23,1 SAY SPACE(78)
         @ 23,40-(LEN(MES)/2) SAY MES
         SET DEVI TO PRINT
         select 4
         continue
         LOOP
      endif

      STORE VEZ + 1 TO VEZ
      STORE GENTE + 1 TO GENTE
      select 2
      STORE SPACE(10) TO WCEDULA,WNOMBRE,WAPELLIDO,WCLASIF
      STORE SPACE(3)  TO WDES3,WDES4,WDESC3,WDESC4,WDESCR3,WDESCR4
      STORE 0 TO WBASICO,WBONOCO,WSALBAS,WSALNOR,WSUELDO,WDIASTRAB,WDIASTRABD,WDIASTRABM,WDIASTRABN
      STORE 0 TO WHORASOR,WHORASORD,WHORASORM,WHORASORN,WBSORD,WBSORDD,WBSORDM,WBSORDN,WSTDA,WSTDB,WSTDABS,WSTDBBS,WSTMA,WSTMB,WSTMABS,WSTMBBS
      STORE 0 TO WSTNA,WSTNB,WSTNABS,WSTNBBS,WTOTSTHR,WTOTSTBS,WSTGM,WSTGN,WSTGMBS,WSTGNBS
      STORE 0 TO WTVDA,WTVDABS,WTVMA,WTVMABS,WTVNA,WTVNABS,WTVDB,WTVMB,WTVNB,WTVDBBS,WTVMBBS,WTVNBBS
      STORE 0 TO WTOTTVHR,WTOTTVBS,WDESNORHR,WDESNORBS,WDC,WDCBS,WBCHR,WBCBS,WFERHORAS,WFERTOT,WFERPRIHR,WFERPRIBS,WBNGHR,WBNGBS
      STORE 0 TO WDESCONHR,WDESCONBS,WDESLEGHR,WDESLEGBS,WBNVBS,WBNV,WCOMIDA,WCOMIDABS,WAYUCIUHR,WAYUCIUBS,WBN,WBNBS,WBDHR,WBDBS
      STORE 0 TO WREPCOM,WREPCOMBS,WOCBHR1,WOCBHR2,WOCBHR3,WOCBHR4,WOCBBS1,WOCBBS2,WOCBBS3,WOCBBS4,WTOTBON
      STORE 0 TO WCESTA,WVIVE,WVIVEBS,WBONOTRAN,WBONOALIM,WBONOSUBS,WOCNB3,WOCNB4,WUTILIDAD,WINDEMNIZA,WTOTNBON
      STORE 0 TO WCAJA,WISLR,WSSO,WSPF,WPRESPER,WSINDIC,WOD3,WOD4,WAHRHAB,WTOTDEC
      STORE 0 TO WNETOPAGAR
      DO IPN0000
      ***********************
      IF WTOTBON+WTOTNBON = 0
         SELECT 4
         CONTINUE
         LOOP
      ENDIF
      IF POSI = 1
         @ PROW(),1 SAY CHR(14)+warning+CHR(18)
         SET DEVI TO SCRE
         CLOSE DATA
         CLOSE INDEX
         QUIT
      ENDIF

      ***************************
      ***  CREAR HISTORICO    ***
      ***************************
      SELECT 6
      STORE WCEDULA+DTOC(NOMINA->APERT2)+WCODNOM TO CLAVE
      FIND &CLAVE
      IF EOF()
         APPEND BLANK
      ENDIF
      REPLACE CEDULA    WITH PERSONAL->CEDULA
      REPLACE NOMINA    WITH NOMINA->CODNOM
      REPLACE FECHA     WITH NOMINA->APERT2
      REPLACE ELABORADA WITH WFECACT
      REPLACE BASICO    WITH WBASICO
      REPLACE HRORD     WITH WHORASOR
      REPLACE HRORDd    WITH WHORASORd
      REPLACE HRORDm    WITH WHORASORm
      REPLACE HRORDn    WITH WHORASORn
      REPLACE BSORD     WITH WBSORD
      REPLACE BSORDd    WITH WBSORDd
      REPLACE BSORDm    WITH WBSORDm
      REPLACE BSORDn    WITH WBSORDn
      REPLACE HRST      WITH WTOTSTHR
      replace hrstda    with wstda
      replace hrstdb    with wstdb
      replace hrstma    with wstma
      replace hrstmb    with wstmb
      replace hrstna    with wstna
      replace hrstnb    with wstnb
      replace hrstGM    with wstGM
      replace hrstGN    with wstGN
      REPLACE BSST      WITH WTOTSTBS
      replace bsstda    with wstdabs
      replace bsstdb    with wstdbbs
      replace bsstma    with wstmabs
      replace bsstmb    with wstmbbs
      replace bsstna    with wstnabs
      replace bsstnb    with wstnbbs
      replace bsstGM    with wstGMbs
      replace bsstGN    with wstGNbs
      REPLACE HRTV      WITH WTOTTVHR
      REPLACE HRTVda    WITH Wtvda
      REPLACE HRTVdb    WITH Wtvdb
      REPLACE HRTVma    WITH Wtvma
      REPLACE HRTVmb    WITH Wtvmb
      REPLACE HRTVna    WITH Wtvna
      REPLACE HRTVnb    WITH Wtvnb
      REPLACE BSTV      WITH WTOTTVBS
      REPLACE BSTVda    WITH Wtvdabs
      REPLACE BSTVdb    WITH Wtvdbbs
      REPLACE BSTVma    WITH Wtvmabs
      REPLACE BSTVmb    WITH Wtvmbbs
      REPLACE BSTVna    WITH Wtvnabs
      REPLACE BSTVnb    WITH Wtvnbbs
      REPLACE HRDESNOR  WITH WDESNORHR
      REPLACE BSDESNOR  WITH WDESNORBS
      REPLACE CTDESCON  WITH PROCESO->P_TDESCON
      REPLACE HRDESCON  WITH WDESCONHR
      REPLACE BSDESCON  WITH WDESCONBS
      REPLACE CTDESLEG  WITH PROCESO->P_TDESLEG
      REPLACE HRDESLEG  WITH WDESLEGHR
      REPLACE BSDESLEG  WITH WDESLEGBS
      REPLACE HRDESCOM  WITH WDC
      REPLACE BSDESCOM  WITH WDCBS
      REPLACE HRAYUCIU  WITH WAYUCIUHR
      IF WAYUCIUBS = 0
         REPLACE HRAYUCIU WITH 0
      ENDIF
      REPLACE BSAYUCIU  WITH WAYUCIUBS
      REPLACE HRCOMIDA  WITH WCOMIDA
      REPLACE BSCOMIDA  WITH WCOMIDABS
      REPLACE HRREPCOM  WITH WREPCOM
      REPLACE BSREPCOM  WITH WREPCOMBS
      REPLACE HRFERIADO WITH WFERHORAS
      REPLACE BSFERIADO WITH WFERTOT
      REPLACE HRBN      WITH WBN
      REPLACE BSBN      WITH WBNBS
      REPLACE HRBNG     WITH WBNGHR
      REPLACE BSBNG     WITH WBNGBS
      REPLACE HRBNV     WITH WBNV
      REPLACE BSBNV     WITH WBNVBS
      REPLACE HRBD      WITH WBDHR
      REPLACE BSBD      WITH WBDBS
      REPLACE FERPRID   WITH PROCESO->P_FERPRID
      REPLACE FTDNOR    WITH PROCESO->P_FTDNOR
      REPLACE FTDDES    WITH PROCESO->P_FTDDES
      REPLACE FERPRIM   WITH PROCESO->P_FERPRIM
      REPLACE FTMNOR    WITH PROCESO->P_FTMNOR
      REPLACE FTMDES    WITH PROCESO->P_FTMDES
      REPLACE FERPRIN   WITH PROCESO->P_FERPRIN
      REPLACE FTNNOR    WITH PROCESO->P_FTNNOR
      REPLACE FTNDES    WITH PROCESO->P_FTNDES
      REPLACE HRFERPRI  WITH WFERPRIHR
      REPLACE BSFERPRI  WITH WFERPRIBS
      REPLACE HRBONOCOM WITH WBCHR
      REPLACE BSBONOCOM WITH WBCBS
      REPLACE DESOCB1   WITH WDES3
      REPLACE HROCB1    WITH WOCBHR3
      REPLACE BSOCB1    WITH WOCBBS3
      REPLACE DESOCB2   WITH WDES4
      REPLACE HROCB2    WITH WOCBHR4
      REPLACE BSOCB2    WITH WOCBBS4
      REPLACE BSTOTBON  WITH WTOTBON

      REPLACE BSBONOTRAN WITH WBONOTRAN
      REPLACE BSBONOALIM WITH WBONOALIM
      REPLACE BSBONOSUBS WITH WBONOSUBS
      REPLACE BSCESTA    WITH WCESTA
      REPLACE BSVIVE     WITH WVIVEBS
      replace bsutilidad with wutilidad
      replace bsindemniz with windemniza
      REPLACE DESOCNB1   WITH WDESC3
      REPLACE BSOCNB1    WITH WOCNB3
      REPLACE DESOCNB2   WITH WDESC4
      REPLACE BSOCNB2    WITH WOCNB4
      REPLACE BSTOTNBON  WITH WTOTNBON

      REPLACE BSISLR     WITH WISLR
      REPLACE BSSSO      WITH WSSO
      REPLACE BSSPF      WITH WSPF
      REPLACE BSAHRHAB   WITH WAHRHAB
      REPLACE BScaja     WITH Wcaja
      REPLACE BSSINDIC   WITH WSINDIC
      REPLACE BSPRESPER  WITH WPRESPER
      REPLACE DESOD1     WITH WDESCR3
      REPLACE BSOD1      WITH WOD3
      REPLACE DESOD2     WITH WDESCR4
      REPLACE BSOD2      WITH WOD4
      REPLACE BSTOTDEC   WITH WTOTDEC

      SELECT 4
      REPLACE UTILACUM WITH UTILACUM+WTOTBON
      *******************************
      REPLACE MP WITH MP - PROCESO->P_PRESPER
      IF MP < 0
         REPLACE MP WITH 0
      ENDIF
      CONTINUE
   ENDDO
   SELECT 1
   REPLACE ESTADO WITH 0
   REPLACE LAST1 WITH APERT1
   REPLACE LAST2 WITH APERT2
   SELECT 2
   DELETE ALL FOR P_NOMINA = WCODNOM
   PACK
   SET DEVI TO SCREE
   SELECT 1
ENDDO

