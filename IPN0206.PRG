****************************************************************************
*                  PROGRAMA PARA CALCULAR DESGLOSE DE NOMINA               *
****************************************************************************
store "INSTALACION NO AUTORIZADA" to warning
STORE "CALCULAR DESGLOSE" TO T2
SELECT 1 
USE IPNOMINA INDEX IPNOMINA ALIAS NOMINA
SELECT 2
USE IPNPROCO INDEX IPNPROCO ALIAS PROCESO
SELECT 3
USE IPNFACTO INDEX IPNFACTO ALIAS TABLA
SELECT 4
USE IPNPERSO  ALIAS PERSONAL
SELECT 5
USE IPNOTCON INDEX IPNOTCON
select 8
use ipncargos index ipncargos
SELECT 9
USE IPNSINDI
SELECT 10
USE IPNUTILI
STORE .T. TO REPORTA
DO WHILE REPORTA
   STORE .T. TO NOMINA
   DO WHILE NOMINA
      STORE 0 TO WWTOTA
      STORE 0 TO WWTOTB
      STORE 0 TO WWTOTC
      STORE 0 TO WWTOTD
      SELECT 1
      STORE SPACE(5) TO WCODNOM
      SET COLOR TO W+/B
      @ 5,1 CLEAR TO 12,50
      @ 5,1 TO 12,50 DOUBLE
      @ 5,25-(LEN(T2)/2) SAY T2
      STORE "CODIGO DE LA NOMINA:" to mess
      do mensaje with mess
      @ 7, 3 say "NOMINA     : " GET WCODNOM
      @ 9, 3 SAY "DESCRIPCION:"
      READ
      STORE UPPER(WCODNOM) TO WCODNOM
      IF WCODNOM=SPACE(5)
         CLOSE DATA
         CLOSE INDEX
         RETURN
      ENDIF
      FIND &WCODNOM
      IF EOF()
         STORE "NOMINA NO REGISTRADA" to mes
         do aviso with mes
         loop
      else
         store desnom to wdesnom
      endif
      @ 9,16 SAY WDESNOM
      STORE 0 TO WSOBREI
      STORE 0 TO WSOBREF
      STORE "OPCIONES: (C)ONTINUAR, (S)ALIR"to mes
      store "C" to p1
      store "S" to p2
      store " " to resp
      do pide2 with p1,p2,mes,resp
      if resp = "S"
         close data
         close index
         return
      endif
      if estado = 0
         store "ERROR, esta nomina esta cerrada " to mes
         do aviso with mes
         loop
      else
         exit
      endif
   ENDDO
   STORE FACTCOD TO WFACTOR
   STORE "DESEA INICIAR LOS TOTALES ACUMULADOS DE DESGLOSE ? (S/N)" to mes
   store "S" to p1
   store "N" to p2
   store " " to resp
   do pide2 with p1,p2,mes,resp
   if resp = "S"
      DO INIDESFIL
   endif
   SELECT 3
   FIND &WFACTOR
   IF EOF()
      STORE "ERROR, TABLA DE FACTORES DE ESTA NOMINA NO ESTA REGISTRADA" TO MES
      DO AVISO WITH MESS
      LOOP
   ENDIF
   *
   STORE 0 TO TOT20000
   STORE 0 TO TOT10000
   STORE 0 TO TOT5000
   STORE 0 TO TOT2000
   STORE 0 TO TOT1000
   STORE 0 TO TOT500
   STORE 0 TO TOT100
   STORE 0 TO TOT50
   STORE 0 TO TOT20
   STORE 0 TO TOT10
   STORE 0 TO TOT5
   STORE 0 TO TOT2
   STORE 0 TO TOT1
   STORE 0 TO TOT050
   STORE 0 TO TOT025
   STORE 0 TO TOT005
   *
   SELECT 4
   GO TOP
   LOCATE FOR NOMINA = WCODNOM
   DO WHILE .NOT. EOF()
      STORE CEDULA TO WCEDULA
      SELECT 2
      FIND &WCEDULA
      IF EOF()
         STORE "ADVERTENCIA:"+RTRIM(personal->nombre)+" "+RTRIM(personal->apellido)+" sin reg. de corte." to mes
         SET DEVI TO SCREE
         @ 23,1 SAY SPACE(78)
         @ 23,40-(LEN(MES)/2) SAY MES
         select 4
         continue
         LOOP
      endif
      SELECT 9
      LOCATE FOR CONTRATO = PERSONAL->SINDICATO
      IF FOUND()
         STORE DEFINICION TO QWRESTO
         ELSE
         STORE "NO REGISTRADO" TO QWRESTO
      ENDIF

      select 2
      *** CALCULO DE PAGO ***
      STORE SPACE(10) TO WCEDULA,WNOMBRE,WAPELLIDO,WCLASIF
      STORE SPACE(3)  TO WDES3,WDES4,WDESC3,WDESC4,WDESCR3,WDESCR4
      STORE 0 TO WBASICO,WBONOCO,WSALBAS,WSALNOR,WSUELDO,WDIASTRAB,WDIASTRABD,WDIASTRABM,WDIASTRABN
      STORE 0 TO WHORASOR,WHORASORD,WHORASORM,WHORASORN,WBSORD,WBSORDD,WBSORDM,WBSORDN,WSTDA,WSTDB,WSTDABS,WSTDBBS,WSTMA,WSTMB,WSTMABS,WSTMBBS
      STORE 0 TO WSTNA,WSTNB,WSTNABS,WSTNBBS,WTOTSTHR,WTOTSTBS,WSTGM,WSTGN,WSTGMBS,WSTGNBS
      STORE 0 TO WTVDA,WTVDABS,WTVMA,WTVMABS,WTVNA,WTVNABS,WTVDB,WTVMB,WTVNB,WTVDBBS,WTVMBBS,WTVNBBS
      STORE 0 TO WTOTTVHR,WTOTTVBS,WDESNORHR,WDESNORBS,WDC,WDCBS,WBCHR,WBCBS,WFERHORAS,WFERTOT,WFERPRIHR,WFERPRIBS,WBNGHR,WBNGBS
      STORE 0 TO WDESCONHR,WDESCONBS,WDESLEGHR,WDESLEGBS,WBNVBS,WBNV,WCOMIDA,WCOMIDABS,WAYUCIUHR,WAYUCIUBS,WBN,WBNBS,WBDHR,WBDBS
      STORE 0 TO WREPCOM,WREPCOMBS,WOCBHR1,WOCBHR2,WOCBHR3,WOCBHR4,WOCBBS1,WOCBBS2,WOCBBS3,WOCBBS4,WTOTBON
      STORE 0 TO WCESTA,WVIVE,WVIVEBS,WBONOTRAN,WBONOALIM,WBONOSUBS,WOCNB3,WOCNB4,WUTILIDAD,WINDEMNIZA,WTOTNBON
      STORE 0 TO WCAJA,WISLR,WSSO,WSPF,WPRESPER,WSINDIC,WOD3,WOD4,WAHRHAB,WTOTDEC
      STORE 0 TO WNETOPAGAR
      DO IPN0000
      ***********************
      IF WTOTBON+WTOTNBON = 0
         SELECT 4
         CONTINUE
         LOOP
      ENDIF
     SELECT 2
     STORE 0 TO NETO20000
     STORE 0 TO NETO10000
     STORE 0 TO NETO5000
     STORE 0 TO NETO2000
     STORE 0 TO NETO1000
     STORE 0 TO NETO500
     STORE 0 TO NETO100
     STORE 0 TO NETO50
     STORE 0 TO NETO20
     STORE 0 TO NETO10
     STORE 0 TO NETO5
     STORE 0 TO NETO2
     STORE 0 TO NETO1
     STORE 0 TO NETO050
     STORE 0 TO NETO025
     STORE 0 TO NETO005
     DO CALDESPER
     DO TOTDESNOM
     SELECT 4
     CONTINUE
   ENDDO
   SAVE SCRE TO S5
   DO DISDESNOM
   DO ACTDESFIL
   STORE 0 TO FF20000
   STORE 0 TO FF10000
   STORE 0 TO FF5000
   STORE 0 TO FF2000
   STORE 0 TO FF1000
   STORE 0 TO FF500
   STORE 0 TO FF100
   STORE 0 TO FF50
   STORE 0 TO FF20
   STORE 0 TO FF10
   STORE 0 TO FF5
   STORE 0 TO FF2
   STORE 0 TO FF1
   STORE 0 TO FF05
   STORE 0 TO FF025
   STORE 0 TO FF005
   DO DISDESACU
   restore scre from s5
ENDDO

