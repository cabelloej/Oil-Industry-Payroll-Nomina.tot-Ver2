*** VALORES INICIALES A SER TRANSFERIDOS A IPN0309R
STORE 0 TO WXTOTDIA
STORE 0 TO BSTOTDIA
STORE 0 TO BSAYUDA
STORE 0 TO BSVIVE
STORE 0 TO BSCESTA
STORE 0 TO BSHOREXT
STORE 0 TO BSBONNOC
STORE 0 TO BSHORVIA
STORE 0 TO BSCOMIDA
STORE 0 TO BSREPCOM
STORE 0 TO BSUTIL
*** FIN

STORE 0 TO QQTOTGEN
STORE 0 TO XXDIAORD
STORE 0 TO XXDESNOR
STORE 0 TO XXDESTRA
STORE 0 TO XXPRIDOM
STORE 0 TO XXDIAFER
STORE 0 TO XXTOTDIA
STORE 0 TO XXTOTPAG
STORE 0 TO XXAYUDA
STORE 0 TO XXAYUDABS
STORE 0 TO XXVIVE
STORE 0 TO XXVIVEBS
STORE 0 TO XXCESTA
STORE 0 TO XXCESTABS
STORE 0 TO XXHOREXT
STORE 0 TO XXHOREXTBS
STORE 0 TO XXBONNOC
STORE 0 TO XXBONNOCBS
STORE 0 TO XXHORVIA
STORE 0 TO XXHORVIABS
STORE 0 TO XXCOMIDA
STORE 0 TO XXREPCOM
STORE 0 TO XXCOMIDABS
STORE 0 TO XXREPCOMBS
STORE 0 TO XXUTILIDAD

STORE 0 TO QXDESNOR
STORE 0 TO QXDIANOR
STORE 0 TO QXAYUDA
STORE 0 TO QXVIVE
STORE 0 TO FLAG
STORE 0 TO WDIRR
select 2
use ipnperso INDEX IPNPERSO
select 4
use ipnretro
SELECT 9
USE IPNCARGO INDEX IPNCARGO
store .t. to retro
do while retro
   SELECT 4
   store date() to wdesde
   store date() to whasta
   STORE SPACE(5) TO WNOMINA
   SET COLOR TO W+/B
   @ 5,0 clear
   @ 5,30 say "CALCULO DE RETROACTIVO"
   @ 6,5 SAY  "No.DIAS A RETROC.:" GET WDIRR   PICTURE "###.##"
   @ 7,5 SAY  "FACTOR SOBRE TMP.:" GET WEXTRA  PICTURE "###.##"
   @ 8,5 SAY  "FACTOR TMP. VIAJE:" GET WVIAJE  PICTURE "###.##"
   @ 09,5 SAY "AYUDA DE CIUDAD  :" GET WAYUDA  PICTURE "###.##"
   @ 10,5 SAY "VIVIENDA         :" GET WVIVE   PICTURE "###.##"
   @ 11,5 SAY "FACTOR B.NOCTURNO:" GET WNOCTU  PICTURE "###.##"
   @ 12,5 SAY "COMIDAS          :" GET WCOMIDA PICTURE "###.##"
   @ 13,5 SAY "UTILIDAD         :" GET WUTIL   PICTURE "###.##"
   @ 14,5 SAY "DESDE            :" GET WDESDE
   @ 15,5 SAY "HASTA            :" GET WHASTA
   @ 16,5 SAY "DESC. ADDIC.Hrs. :" GET WDESADD  PICTURE "###.##"
   @ 17,5 SAY "DIAS. ADDIC.Hrs. :" GET WDIAADD  PICTURE "###.##"
   @ 18,5 SAY "AYUDA Cda. dias  :" GET WAYUADD
   @ 19,5 SAY "VIVIENDA   dias  :" GET QXVIVE   PICTURE "###.##"
   @ 20,5 SAY "CESTA BAS.Difere.:" GET WCESTA   PICTURE "######.##"
   @ 21,5 SAY "NOMINA           :"
   @ 22,5 SAY "ESTATUS (A,I)    :"
   READ
   STORE WDIAADD TO QXDIANOR
   STORE WDESADD/8 TO QXDESNOR
   STORE WAYUADD TO QXAYUDA
   @ 21,5 SAY "NOMINA           :" GET WNOMINA
   READ
   IF WNOMINA = SPACE(5)
      CLOSE DATA
      CLOSE INDEX
      RETURN
   ENDIF
   SELECT 3
   USE IPNOMINA INDEX IPNOMINA
   FIND &WNOMINA
   IF EOF()
      STORE "NOMINA NO REGISTRADA" TO MES
      DO AVISO WITH MES
      CLOSE DATA
      CLOSE INDEX
      RETURN
   ENDIF
   @ 21,35 SAY DESNOM
   STORE .T. TO WESTATUS
   DO WHILE WESTATUS
      STORE SPACE(1) TO WSTAT
      STORE "ESTATUS: (A)CTIVOS, (I)NACTIVOS, <ENTER>=TODOS" TO MES
      DO MENSAJE WITH MES
      @ 22,24 GET WSTAT
      READ
      IF WSTAT=" ".OR. WSTAT="I".OR.WSTAT="A"
         EXIT
      ENDIF
   ENDDO
   IF WSTAT = "A"
      STORE "PERSONAL ACTIVO" TO WSELECCION
   ELSE
      IF WSTAT = "I"
         STORE "PERSONAL INACTIVO" TO WSELECCION
      ELSE
         STORE " " TO WSELECCION
      ENDIF
   ENDIF

   STORE (WHASTA-WDESDE)+1 TO WMAXDIAS
   *** DETERMINAR LA CANTIDAD DE DIAS NORMALES Y DESCANSOS
   STORE WDESDE TO WCHECK
   STORE 0      TO WTOTNOR
   STORE 0      TO WTOTDES
   DO WHILE WCHECK <= WHASTA
      IF DOW(WCHECK)>1.AND.DOW(WCHECK)<7
         STORE WTOTNOR + 1 TO WTOTNOR
      ELSE
         STORE WTOTDES + 1 TO WTOTDES
      ENDIF
      STORE WCHECK + 1 TO WCHECK
   ENDDO
   ***
   STORE "MAXIMO="+STR(WMAXDIAS)+" NORMALES="+STR(WTOTNOR)+" DESCANSO="+STR(WTOTDES) TO MES
   DO AVISO WITH MES
   STORE "OPCIONES: (C)ONTINUAR, (S)ALIR" to mes
   store "C" to p1
   store "S" to p2
   store " " to resp
   do pide2 with p1,p2,mes,resp
   if resp = "S"
      close data
      close index
      return
   endif
   SELECT 1
   USE IPNHISTO
   COPY STRU TO IPNX
   SELECT 1
   USE IPNX
   INDEX ON CEDULA TO IPNX
   APPEND FROM IPNHISTO FOR FECHA >= WDESDE .AND. FECHA <= WHASTA .AND. NOMINA = WNOMINA
   SET INDEX TO IPNX
   STORE QXDIANOR TO WXDIAORD
   STORE QXDESNOR TO WXDESNOR
   STORE 0 TO WXDESTRA
   STORE 0 TO WXPRIDOM
   STORE 0 TO WXDIAFER
   STORE QXAYUDA TO WXAYUDA
   STORE QXVIVE TO WXVIVE
   STORE 0 TO WXHOREXT
   STORE 0 TO WXBONNOC
   STORE 0 TO WXHORVIA
   STORE 0 TO WXCOMIDA
   STORE 0 TO WXREPCOM
   STORE 0 TO WXCESTA
   STORE 0 TO LINE
   DO HEAD0309
   SELECT 1
   GO TOP
   STORE CEDULA TO WCEDULA
   STORE BASICO TO WBASICO
*  STORE FECHA -7 TO WINGRESO
   STORE .F. TO WFLAGRUP
   DO WHILE .NOT. EOF()
      STORE CEDULA TO YCEDULA
      SELECT 2
      FIND &YCEDULA
      IF EOF()
         SET DEVI TO SCRE
         STORE "CEDULA :"+YCEDULA+ "EN HISTORICOS NO REG. EN FICHA PERSONAL" TO MES
         DO AVISO WITH MES
         CLOSE DATA
         CLOSE INDEX
         RETURN
      ENDIF
      STORE NOMINA TO YNOMINA
      SELECT 1
      IF YNOMINA = SPACE(5)
         STORE "I" TO XSTAT
      ELSE
         STORE "A" TO XSTAT
      ENDIF
      IF WSTAT <> " " .AND. WSTAT <> XSTAT
         SELECT 1
         SKIP
         LOOP
      ENDIF
      IF .NOT. WFLAGRUP
         STORE CEDULA TO WCEDULA
         STORE .T. TO WFLAGRUP
      ENDIF
      IF CEDULA <> WCEDULA
         DO IPN0309R
         **************
         STORE XXDIAORD     + WXDIAORD     TO XXDIAORD
         STORE XXDESNOR     + WXDESNOR     TO XXDESNOR
         STORE XXDESTRA     + WXDESTRA     TO XXDESTRA
         STORE XXPRIDOM     + WXPRIDOM     TO XXPRIDOM
         STORE XXDIAFER     + WXDIAFER     TO XXDIAFER
         STORE XXTOTDIA     + WXTOTDIA     TO XXTOTDIA
         STORE XXTOTPAG     + BSTOTDIA     TO XXTOTPAG
         STORE XXAYUDA      + WXAYUDA      TO XXAYUDA
         STORE XXAYUDABS    + BSAYUDA      TO XXAYUDABS
         STORE XXVIVE       + WXVIVE       TO XXVIVE
         STORE XXVIVEBS     + BSVIVE       TO XXVIVEBS
         STORE XXCESTA      + WXCESTA      TO XXCESTA
         STORE XXCESTABS    + BSCESTA      TO XXCESTABS
         STORE XXHOREXT     + WXHOREXT     TO XXHOREXT
         STORE XXHOREXTBS   + BSHOREXT     TO XXHOREXTBS
         STORE XXBONNOC     + WXBONNOC     TO XXBONNOC
         STORE XXBONNOCBS   + BSBONNOC     TO XXBONNOCBS
         STORE XXHORVIA     + WXHORVIA     TO XXHORVIA
         STORE XXHORVIABS   + BSHORVIA     TO XXHORVIABS
         STORE XXCOMIDA     + WXCOMIDA     TO XXCOMIDA
         STORE XXREPCOM     + WXREPCOM     TO XXREPCOM
         STORE XXCOMIDABS   + BSCOMIDA     TO XXCOMIDABS
         STORE XXREPCOMBS   + BSREPCOM     TO XXREPCOMBS
         STORE XXUTILIDAD   + BSUTIL       TO XXUTILIDAD
         ***************
         STORE QXDIANOR TO WXDIAORD
         STORE QXDESNOR TO WXDESNOR
         STORE 0 TO WXDESTRA
         STORE 0 TO WXPRIDOM
         STORE 0 TO WXDIAFER
         STORE QXAYUDA TO WXAYUDA
         STORE QXVIVE TO WXVIVE
         STORE 0 TO WXHOREXT
         STORE 0 TO WXBONNOC
         STORE 0 TO WXHORVIA
         STORE 0 TO WXCOMIDA
         STORE 0 TO WXREPCOM
         STORE 0 TO WXCESTA
         SELECT 1
         STORE CEDULA TO WCEDULA
         STORE BASICO TO WBASICO
      ENDIF
      STORE  WXDIAORD+HRORD TO WXDIAORD
      IF DESOCB1 = "V "
         *** DETERMINAR LA CANTIDAD DE DIAS NORMALES EN LA VACACION
         STORE FECHA  TO WCHECK
         IF FECHA+30 > WHASTA
            STORE WHASTA   TO WFECHATOP
         ELSE
            STORE FECHA+30 TO WFECHATOP
         ENDIF
         STORE 0      TO WTOTCONT
         DO WHILE WCHECK <= WFECHATOP
            IF DOW(WCHECK)>1.AND.DOW(WCHECK)<7
               STORE WTOTCONT + 1 TO WTOTCONT
            ENDIF
            STORE WCHECK + 1 TO WCHECK
         ENDDO
         STORE WTOTCONT*8 TO WTOTCONT
         STORE WXDIAORD+WTOTCONT TO WXDIAORD
      ENDIF
      STORE  WXDESNOR+(HRDESNOR/8) TO WXDESNOR
      IF DESOCB1 = "V "
         *** DETERMINAR LA CANTIDAD DE DIAS DE DESCANSO EN LA VACACION
         STORE FECHA  TO WCHECK
         IF FECHA+30 > WHASTA
            STORE WHASTA   TO WFECHATOP
         ELSE
            STORE FECHA+30 TO WFECHATOP
         ENDIF
         STORE 0      TO WTOTCONT
         DO WHILE WCHECK <= WFECHATOP
            IF DOW(WCHECK)=1.OR.DOW(WCHECK)=7
               STORE WTOTCONT + 1 TO WTOTCONT
            ENDIF
            STORE WCHECK + 1 TO WCHECK
         ENDDO
         STORE WXDESNOR+WTOTCONT TO WXDESNOR
      ENDIF
      STORE  WXDESTRA+(HRDESCON/8)+(HRDESLEG/8)+(HRDESCOM/8) TO WXDESTRA
      IF DESOCB1 = "DC"
         STORE WXDESTRA+(HROCB1/8) TO WXDESTRA
      ENDIF
      IF DESOCB2 = "DC"
         STORE WXDESTRA+(HROCB2/8) TO WXDESTRA
      ENDIF
      IF DESOCB3 = "DC"
         STORE WXDESTRA+(HROCB3/8) TO WXDESTRA
      ENDIF

      STORE  WXPRIDOM +(HRBD/8)+(HRFERPRI/8) TO WXPRIDOM

      IF SUBSTR(DESOCB1,1,1) = "F"
         STORE WXDIAFER+(HROCB1/8) TO WXDIAFER
      ENDIF
      IF SUBSTR(DESOCB2,1,1) = "F"
         STORE WXDIAFER+(HROCB2/8) TO WXDIAFER
      ENDIF
      IF SUBSTR(DESOCB3,1,1) = "F"
         STORE WXDIAFER+(HROCB3/8) TO WXDIAFER
      ENDIF
      STORE WXDIAFER+(HRFERIADO/8) TO WXDIAFER

      STORE  WXAYUDA+(HRAYUCIU/8) TO WXAYUDA
      STORE  WXVIVE+(BSVIVE/50) TO WXVIVE
      IF BSCESTA > 0
         STORE WXCESTA + 1 TO WXCESTA
      ENDIF
      STORE  WXHOREXT + HRST TO WXHOREXT
      STORE  WXBONNOC + HRBN+HRBNG+HRBNV TO WXBONNOC
      STORE  WXHORVIA + HRTV TO WXHORVIA
      STORE  WXCOMIDA + HRCOMIDA TO WXCOMIDA
      STORE  WXREPCOM + HRREPCOM TO WXREPCOM
      SKIP
   ENDDO
   DO IPN0309R
   STORE XXDIAORD     + WXDIAORD     TO XXDIAORD
   STORE XXDESNOR     + WXDESNOR     TO XXDESNOR
   STORE XXDESTRA     + WXDESTRA     TO XXDESTRA
   STORE XXPRIDOM     + WXPRIDOM     TO XXPRIDOM
   STORE XXDIAFER     + WXDIAFER     TO XXDIAFER
   STORE XXTOTDIA     + WXTOTDIA     TO XXTOTDIA
   STORE XXTOTPAG     + BSTOTDIA     TO XXTOTPAG
   STORE XXAYUDA      + WXAYUDA      TO XXAYUDA
   STORE XXAYUDABS    + BSAYUDA      TO XXAYUDABS
   STORE XXVIVE       + WXVIVE       TO XXVIVE
   STORE XXVIVEBS     + BSVIVE       TO XXVIVEBS
   STORE XXCESTA      + WXCESTA      TO XXCESTA
   STORE XXCESTABS    + BSCESTA      TO XXCESTABS
   STORE XXHOREXT     + WXHOREXT     TO XXHOREXT
   STORE XXHOREXTBS   + BSHOREXT     TO XXHOREXTBS
   STORE XXBONNOC     + WXBONNOC     TO XXBONNOC
   STORE XXBONNOCBS   + BSBONNOC     TO XXBONNOCBS
   STORE XXHORVIA     + WXHORVIA     TO XXHORVIA
   STORE XXHORVIABS   + BSHORVIA     TO XXHORVIABS
   STORE XXCOMIDA     + WXCOMIDA     TO XXCOMIDA
   STORE XXREPCOM     + WXREPCOM     TO XXREPCOM
   STORE XXCOMIDABS   + BSCOMIDA     TO XXCOMIDABS
   STORE XXREPCOMBS   + BSREPCOM     TO XXREPCOMBS
   STORE XXUTILIDAD   + BSUTIL       TO XXUTILIDAD
   STORE LINE+1 TO LINE
   @ LINE,0 SAY  "|                                        |        |        |        |        |       |        |         |                |                |                 |                 |                |                 |         |          |"
   @ line,1 say "T O T A L     R E T R O A C T I V O  :"
   @ LINE,42 SAY XXDIAORD picture  "@z #####.##"
   @ LINE,51 SAY XXDESNOR picture  "@z #####.##"
   @ LINE,60 SAY XXDESTRA picture  "@z #####.##"
   @ LINE,69 SAY XXPRIDOM picture  "@z #####.##"
   @ LINE,77 SAY XXDIAFER picture  "@z #####.##"
   @ LINE,86  SAY XXTOTDIA picture "@z #####.##"
   @ LINE,95  SAY XXTOTPAG picture "@z ######.##"
   @ LINE,106 SAY XXAYUDA+XXVIVE  picture "@z ####"
   @ LINE,112 SAY XXAYUDABS+XXVIVEBS picture "@z ######.##"
   @ LINE,121 SAY XXCESTA picture "@z #####.##"
   @ LINE,130 SAY XXCESTABS picture "@z #####.##"
   @ LINE,138 SAY XXHOREXT picture "@z ####.##"
   @ LINE,147 SAY XXHOREXTBS picture "@z ######.##"
   @ LINE,157 SAY XXBONNOC picture "@z ####.##"
   @ LINE,166 SAY XXBONNOCBS picture "@z #####.##"
   @ LINE,174 SAY XXHORVIA picture "@z ####.##"
   @ LINE,183 SAY XXHORVIABS picture "@z #####.##"
   @ LINE,192 SAY XXCOMIDA picture "@z ####.##"
   @ LINE,201 SAY XXCOMIDABS picture "@z #####.##"
   @ LINE,210 SAY XXUTILIDAD picture "@z ######.##"
   @ LINE,220 SAY QQTOTGEN picture "@z #######.##"
   STORE LINE+1 TO LINE
   @ LINE,0 SAY  "|----------------------------------------+--------+--------+--------+--------+-------+--------+---------+----------------+----------------+-----------------+-----------------+----------------+-----------------|---------|----------|"
   STORE LINE+1 TO LINE
   @ LINE,0 SAY  "|                                        |        |        |        |        |       |        |         |                |                |                 |                 |                |                 |         |          |"
   @ LINE,192 SAY XXREPCOM picture "@z ####.##"
   @ LINE,201 SAY XXREPCOMBS picture "@z #####.##"
   STORE LINE+1 TO LINE
   @ LINE,0 SAY  "|----------------------------------------+--------+--------+--------+--------+-------+--------+---------+----------------+----------------+-----------------+-----------------+----------------+-----------------|---------|----------|"

   STORE .F. TO RETRO
   @ PROW(),0 SAY CHR(18)
   SET DEVI TO SCRE
   EJECT
   close data
   close index
   DELETE FILE IPNX.DBF
   DELETE FILE IPNX.IDX
ENDDO

