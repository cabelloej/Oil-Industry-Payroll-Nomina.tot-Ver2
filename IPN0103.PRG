**********************************************************************
*              Actualizador de archivo de nominas                    *
**********************************************************************
PUSH KEY CLEAR
ON KEY LABEL F1 DO PROCIMP

SELECT 9
USE ipnomina INDEX ipnomina
STORE 0 TO ACTLOC
DO WHILE ACTLOC = 0
   STORE "CODIGO DE NOMINA, F1=VER, <ENTER>=SALIR" TO MES
   DO MENSAJE WITH MES
   SET COLOR TO W+/B
   STORE 10 TO LINE
   STORE 15 TO COL
   @ LINE-1,COL-1 CLEAR TO LINE+12,COL+46
   @ LINE,COL TO LINE+12,COL+45 DOUBLE
   @ LINE,COL+15 SAY "NOMINAS"
   @ LINE+01,COL+1 SAY "CODIGO     :"
   @ LINE+02,COL+1 SAY "DESCRIPCION:"
   @ LINE+03,COL+1 SAY "CONTR.u ORD:"
   @ LINE+04,COL+1 SAY "TIPO       :"
   @ LINE+05,COL+1 SAY "FACTORES   :"
   @ LINE+06,COL+1 SAY "ESTADO ACT.:"
   @ LINE+07,COL+1 SAY "PERIDO ACT.:"
   @ line+08,col+1 say "BONIFICABLE:"
   @ line+09,col+1 say "NO BONIFIC.:"
   @ line+10,col+1 say "LUGAR      :"
  * @ line+11,col+1 say "MONTO TOTAL:"

   STORE SPACE(5) TO CODIGO
   @ LINE+1,COL+13 GET CODIGO
   READ
   IF CODIGO = SPACE(5)
      STORE 1 TO ACTLOC
      LOOP
   ENDIF
   FIND &CODIGO
   IF EOF()
      STORE "CODIGO NO REGISTRADO, DESEA INGRESAR ? (S/N)" TO MES
      STORE " " TO RESP
      STORE "S" TO P1
      STORE "N" TO P2
      DO PIDE2 WITH P1,P2,MES,RESP
      IF RESP <> "N"
         APPEND BLANK
         REPLACE CODNOM WITH CODIGO
         @ LINE+2,COL+13 GET DESNOM
         READ
         @ LINE+3,COL+13 GET CONTRATO
         @ LINE+3,COL+30 GET ORDEN
         READ

         STORE "TIPOS DE NOMINA : (O)BREROS (E)MPLEADOS" TO MES
         DO MENSAJE WITH MES
         STORE TIPO TO WTIPO
         STORE .T. TO CHECK
         DO WHILE CHECK
            @ LINE+4,COL+13 GET WTIPO
            READ
            STORE UPPER(WTIPO) TO WTIPO
            IF WTIPO = "O" .OR. WTIPO = "E"
               STORE .F. TO CHECK
            ENDIF
         ENDDO

         STORE .T. TO CHECFAC
         DO WHILE CHECFAC
            STORE SPACE(5) TO WFACTOR
            STORE "INGRESE EL CODIGO DE LOS FACTORES A UTILIZAR" TO MES
            DO MENSAJE WITH MES
            @ LINE+5,COL+13 GET WFACTOR
            READ
            IF WFACTOR = SPACE(5)
               STORE "INGRESO DE NOMINA RECHAZADO. (Ù)" TO MES
               DO AVISO WITH MES
               LOOP
            ENDIF
            SELECT 3
            USE IPNFACTOR INDEX IPNFACTOR ALIAS TABLA
            FIND &WFACTOR
            IF EOF()
               STORE "CODIGO DE FACTORES NO REGISTRADO, PRIMERO INGRESE FACTORES" TO MES
               DO AVISO WITH MES
               SELECT 9
               DELETE
               CLOSE DATA
               CLOSE INDEX
               RETURN
            ENDIF
            STORE SPACE(12) TO WCODBON
            STORE "INGRESE EL CODIGO CONTABLE DE CONCEPTOS BONIFICABLES" TO MES
            DO MENSAJE WITH MES
            @ LINE+8,COL+13 GET WCODBON
            READ
            STORE SPACE(12) TO WCODNOBON
            STORE "INGRESE EL CODIGO CONTABLE DE CONCEPTOS NO BONIFICABLES" TO MES
            DO MENSAJE WITH MES
            @ LINE+9,COL+13 GET WCODNOBON
            READ
            STORE .F. TO CHECFAC
         ENDDO
         SELECT 9
         @ LINE+10,COL+13 GET LUGAR
         READ
         @ LINE+11,COL+13 GET MONTO PICTURE "9999999999.9"
         READ
         REPLACE TIPO WITH WTIPO
         REPLACE FACTCOD WITH WFACTOR
         REPLACE ESTADO WITH 0
         REPLACE CODBON WITH WCODBON
         REPLACE CODNOBON WITH WCODNOBON
      ELSE
         LOOP
      ENDIF
   ELSE
      @ LINE+2,COL+13 SAY DESNOM
      @ LINE+3,COL+13 SAY CONTRATO
      @ LINE+3,COL+30 SAY ORDEN
      @ LINE+4,COL+13 SAY TIPO
      @ LINE+5,COL+13 SAY FACTCOD
      @ LINE+7,COL+13 SAY "DEL "+DTOC(APERT1)+" AL "+DTOC(APERT2)
      @ LINE+8,COL+13 SAY CODBON
      @ LINE+9,COL+13 SAY CODNOBON
      @ LINE+10,COL+13 SAY LUGAR
      @ LINE+11,COL+13 SAY MONTO PICTURE "9999999999.9"

      IF ESTADO = 0
         STORE "CERRADA" TO WSTAT
      ENDIF
      IF ESTADO = 1
         STORE "EN PROCESO" TO WSTAT
      ENDIF
      IF ESTADO = 2
         STORE "NOMINA REPORTADA" TO WSTAT
      ENDIF
      IF ESTADO = 3
         STORE "SOBRES IMPRIMIDOS" TO WSTAT
      ENDIF
      @ LINE+6,COL+13 SAY WSTAT

      STORE "OPCIONES: (M)ODIFICAR, (E)LIMINAR, (S)ALIR" TO MES
      STORE " " TO RESP
      STORE "M" TO P1
      STORE "E" TO P2
      STORE "S" TO P3
      DO PIDE3 WITH P1,P2,P3,MES,RESP
      IF RESP = "S"
         LOOP
      ENDIF
      IF RESP = "E"
         DELETE
         PACK
      ENDIF
      IF RESP = "M"
         @ LINE+2,COL+13 GET DESNOM
         READ
         @ LINE+3,COL+13 GET CONTRATO
         @ LINE+3,COL+30 GET ORDEN
         READ
         STORE "TIPOS DE NOMINA : (O)BREROS (E)MPLEADOS" TO MES
         DO MENSAJE WITH MES
         STORE TIPO TO WTIPO
         STORE .T. TO CHECK
         DO WHILE CHECK
            @ LINE+4,COL+13 GET WTIPO
            READ
            STORE UPPER(WTIPO) TO WTIPO
            IF WTIPO = "O" .OR. WTIPO = "E"
               STORE .F. TO CHECK
            ENDIF
         ENDDO
   
         STORE .T. TO CHECFAC
         STORE 0 TO WBIEN
         DO WHILE CHECFAC
            STORE FACTCOD TO WFACTOR
            IF ESTADO <> 0
               STORE "ESTA NOMINA NO HA SIDO CERRADA, LOS FACTORES NO PUEDEN SER MODIFICADOS" TO MES
               DO AVISO WITH MES
               STORE .F. TO CHECFAC
               LOOP
            ENDIF
            STORE "INGRESE EL CODIGO DE LOS FACTORES A UTILIZAR" TO MES
            DO MENSAJE WITH MES
            @ LINE+5,COL+13 GET WFACTOR
            READ
            IF WFACTOR = SPACE(5)
               LOOP
            ENDIF
            SELECT 3
            USE IPNFACTOR INDEX IPNFACTOR ALIAS TABLA
            FIND &WFACTOR
            IF EOF()
               STORE "CODIGO DE FACTORES NO REGISTRADO, INGRESE FACTORES POR MANTENIMIENTO" TO MES
               DO AVISO WITH MES
               STORE 1 TO WBIEN
               STORE .F. TO CHECFAC
               LOOP
            ENDIF
            STORE .F. TO CHECFAC
         ENDDO
         SELECT 9

         IF WBIEN = 0
            REPLACE FACTCOD WITH WFACTOR
         ENDIF
         REPLACE TIPO WITH WTIPO

         STORE CODBON TO WCODBON
         STORE "INGRESE EL CODIGO CONTABLE DE CONCEPTOS BONIFICABLES" TO MES
         DO MENSAJE WITH MES
         @ LINE+8,COL+13 GET WCODBON
         READ
         REPLACE CODBON WITH WCODBON

         STORE CODNOBON TO WCODNOBON
         STORE "INGRESE EL CODIGO CONTABLE DE CONCEPTOS NO BONIFICABLES" TO MES
         DO MENSAJE WITH MES
         @ LINE+9,COL+13 GET WCODNOBON
         READ
         REPLACE CODNOBON WITH WCODNOBON

         @ LINE+10,COL+13 GET LUGAR
         READ

         @ LINE+11,COL+13 GET MONTO PICTURE "9999999999.9"
         READ
      ENDIF
   ENDIF
ENDDO
POP KEY
CLOSE DATA
CLOSE INDEX
SET COLOR TO
RETURN

************
PROC PROCIMP
************
SAVE SCRE TO WSCREIMP
STORE "OPCIONES: (M)ONITOR, (I)MPRESORA, (S)ALIR" to mess
store "M" TO P1
STORE "I" TO P2
STORE "S" TO P3
STORE " " TO RESP
DO PIDE3 WITH P1, P2, P3, MESS, RESP
STORE "" TO WSALIDA
IF RESP = "M"
   STORE 20  TO WSALTO
   STORE "M" TO WSALIDA
   SET DEVI  TO SCRE
ELSE
   IF RESP = "I"
      STORE 55  TO WSALTO
      STORE "I" TO WSALIDA
      SET DEVI  TO PRINT
   ENDIF
ENDIF
*
IF RESP<>"S"
   STORE 100 TO WLINE
   STORE 0   TO WPAGE
   GO TOP
   DO WHILE .NOT. EOF()
      STORE WLINE+1 TO WLINE
      IF WLINE>=WSALTO
         DO HEADER
      ENDIF
      @ WLINE,00  SAY CODNOM
      @ WLINE,07  SAY DESNOM
      @ WLINE,38  SAY FACTCOD
      @ WLINE,45  SAY TIPO
      IF ESTADO = 0
         STORE "CERRADA" TO CONDICION
      ENDIF
      IF ESTADO = 1
         STORE "EN PROCESO" TO CONDICION
      ENDIF
      IF ESTADO = 2
         STORE "NOMINA REPORTADA" TO CONDICION
      ENDIF
      IF ESTADO = 3
         STORE "SOBRES EMITIDOS" TO CONDICION
      ENDIF
      @ WLINE,54 SAY CONDICION
      SKIP
   ENDDO
ENDIF
IF WSALIDA="M"
   STORE "OPRIMA <ENTER> PARA FINALIZAR" TO MES
   DO AVISO WITH MES
ELSE
   IF WSALIDA = "I"
      EJECT
   ENDIF
ENDIF
SET DEVI TO SCRE
REST SCRE FROM WSCREIMP
RETURN
************
PROC HEADER
************
STORE WPAGE+1 TO WPAGE
IF WSALIDA="M"
   IF WPAGE>1
      STORE "OPRIMA <ENTER> PARA CONTINUAR" TO MES
      DO AVISO WITH MES
   ENDIF
   @ 0,0 CLEAR
ENDIF
IF LASTKEY()=27
   GO BOTT
ENDIF
@ 00,00 SAY QQWW
@ 00,60 SAY "FECHA  : "+DTOC(DATE())
@ 01,00 SAY "SISTEMA DE NOMINA"
@ 01,60 SAY "PAGINA : "+STR(WPAGE,2)
@ 02,00 SAY "LISTADO DE NOMINAS"
@ 04,00 SAY "CODIGO DESCRIPCION                    FACTOR  TIPO  ESTADO"
@ 05,00 SAY "------ ------------------------------ ------  ----  ------"
STORE 06 TO WLINE
RETURN
